var app;(()=>{"use strict";var e={8269:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(4572),s=n(t(4890));r.default=new class{async getUser(e,r){var t;try{if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const n=await s.default.getAllUser();return n?(0,o.sendSuccess)(r,e.t("success"),n):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error getUser: ",e.message),!1}}async confirmUserController(e,r){var t;try{const{id_user:n}=e.body;if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const a=await s.default.confirmUser(n);return a?(0,o.sendSuccess)(r,e.t("success"),a):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error confirmUserController: ",e.message),!1}}async deleteUserController(e,r){var t;try{const{id_user:n}=e.body;if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const a=await s.default.deleteUser(n);return a?(0,o.sendSuccess)(r,e.t("success"),a):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error deleteUserController: ",e.message),!1}}}},2600:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(8269)),a=n(t(780)),i=o.default.Router();i.get("/list",a.default.isAdminToken,s.default.getUser),i.post("/confirm",a.default.isAdminToken,s.default.confirmUserController),i.post("/delete",a.default.isAdminToken,s.default.deleteUserController),r.default=i},4890:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(4664)),s={getAllUser:async function(){try{const{error:e,rows:r}=await o.default.query('SELECT *\n                FROM public."user"\n                WHERE active_email = true\n                AND id_user != 39\n                ORDER BY \n                id_user DESC;',[]);return!e&&r}catch(e){return console.log("error getAllUser: ",e.message),!1}},confirmUser:async function(e){try{const{error:r,rows:t}=await o.default.query('UPDATE "user" SET active = true WHERE id_user = $1 RETURNING *',[e]);return!r&&t}catch(e){return console.log("error confirmUser: ",e.message),!1}},deleteUser:async function(e){try{const{error:r,rows:t}=await o.default.query('UPDATE "user" SET active = false WHERE id_user = $1 RETURNING *',[e]);return!r&&t}catch(e){return console.log("error deleteUser: ",e.message),!1}}};r.default=s},3946:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(2600));r.default=o.default},2657:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(4572),s=n(t(8416)),a=n(t(9538)),i=n(t(7606)),u=n(t(5946)),c=n(t(5260)),{FILE_PATH:l}=c.default;r.default=new class{async createController(e,r){var t;try{if(!(0,s.default)(e.body,a.default.applicationSchema))return(0,o.sendError)(r,e.t("inValidFormat"));let{projectName:n,isProduct:c,isService:d,description:f,deadlines:E,totalSum:p}=e.body;c=null!=c&&c,d=null!=d&&d,c||d?c&&d&&(d=!1):c=!0;const _=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!_)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const m=[];if(e.files&&Array.isArray(e.files.file)){const t=e.files.file;for(const s of t){const t=await u.default.saveFile({path:l,fileName:`${n}-${s.name}`,sampleFile:s,type:"file"});if(t.error)return(0,o.sendError)(r,e.t("Ошибка при загрузке файла"));m.push(t.dbFileName)}}else if(e.files&&e.files.file){const t=e.files.file,s=await u.default.saveFile({path:l,fileName:`${n}-${t.name}`,sampleFile:t,type:"file"});if(s.error)return(0,o.sendError)(r,e.t("Ошибка при загрузке файла"));m.push(s.dbFileName)}return await i.default.create(_,n,c,d,f,E,p,m)?(0,o.sendSuccess)(r,e.t("Заявка успешно создана")):(0,o.sendError)(r,e.t("error"))}catch(t){return console.log("error createController",t.message),(0,o.sendError)(r,e.t("serverError"))}}async getApplicationByUser(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await i.default.findByIdUser(n);return s?(0,o.sendSuccess)(r,e.t("success"),s):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error getApplicationByUser: ",e.message),!1}}async getApplicationByIdController(e,r){var t;try{const{id:n}=e.query;if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=Number(n);let a;return a=await i.default.existWinner(s)?await i.default.getWinnerByIdApplication(s):await i.default.getApplicationById(s),!a||Array.isArray(a)&&0===a.length?(0,o.sendError)(r,e.t("Заявка с таким id не найдена!")):a?(0,o.sendSuccess)(r,e.t("success"),a):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error getApplicationByIdController: ",e.message),!1}}async updateApplication(e,r){var t;try{const{id:n,projectName:s,isProduct:a,isService:c,description:d,deadlines:f,totalSum:E}=e.body,p=Number(n),_=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(console.log("Request body:",e.body),console.log("Files:",e.files),!_)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const m=await i.default.getApplicationById(p);if(!m||0===m.length)return(0,o.sendError)(r,e.t("По данному id тендер не найден"));const y=m[0].files||[],g=[];if(e.files)if(Array.isArray(e.files.file)){const t=e.files.file;for(const e of y)console.log(`Removing old file: ${e}`);for(const n of t){console.log(`Saving new file: ${n.name}`);const t=await u.default.saveFile({path:l,fileName:`${s}-${n.name}`,sampleFile:n,type:"file"});if(t.error)return(0,o.sendError)(r,e.t("Ошибка при загрузке файла"));g.push(t.dbFileName)}}else if(e.files.file){const t=e.files.file;console.log(`Saving new file: ${t.name}`);const n=await u.default.saveFile({path:l,fileName:`${s}-${t.name}`,sampleFile:t,type:"file"});if(n.error)return(0,o.sendError)(r,e.t("Ошибка при загрузке файла"));g.push(n.dbFileName)}console.log("Updating application with data:",{applicationId:p,projectName:s,isProduct:a,isService:c,description:d,deadlines:f,totalSum:E,fileData:g});const h=await i.default.updateApplicationData(p,s,a,c,d,f,E,g);return h?(0,o.sendSuccess)(r,e.t("success"),h):(0,o.sendError)(r,e.t("error"))}catch(t){return console.log("error updateApplicationController: ",t.message),(0,o.sendError)(r,e.t("error.unexpected"))}}async deleteApplicationController(e,r){var t;try{const{id:n}=e.body,s=Number(n);if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const a=await i.default.deleteApplication(s);return a?(0,o.sendSuccess)(r,e.t("Успешно удалено"),a):(0,o.sendError)(r,e.t("error"))}catch(e){return console.error("Error in deleteApplicationController: ",e.message),!1}}async offerListController(e,r){var t;try{const{id:n}=e.params,s=Number(n);if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const a=await i.default.offerCount(s);if(!a)return(0,o.sendError)(r,e.t("По данному id тендер не найден!"));const u=await i.default.offerList(s);if(!u)return(0,o.sendError)(r,e.t("error"));const c=[{countOffer:a},...u];return(0,o.sendSuccess)(r,e.t("Успешно"),c)}catch(e){return console.error("Error in offerListController: ",e.message),!1}}async getOfferByIdController(e,r){var t;try{const{id_offer:n}=e.params,s=Number(n);if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const a=await i.default.getOfferById(s);return a?(0,o.sendSuccess)(r,e.t("Успешно"),a):(0,o.sendError)(r,e.t("error"))}catch(e){return console.error("Error in getOfferByIdController: ",e.message),!1}}async makeToWinnerController(e,r){var t;try{const{id_offer:n,id:s}=e.body,a=Number(n),u=Number(s);if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const c=await i.default.makeToWinner(a);return c?await i.default.updateApplicationWinner(u)?(0,o.sendSuccess)(r,e.t("Успешно"),c):(0,o.sendError)(r,e.t("По данному id заявка не найдена")):(0,o.sendError)(r,e.t("По данному id предложение не найдено"))}catch(t){return console.error("Error in makeToWinnerController: ",t.message),(0,o.sendError)(r,e.t("error.unexpected"))}}async rejectedOfferController(e,r){var t;try{const{id_offer:n}=e.body,s=Number(n);if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const a=await i.default.rejectedOffer(s);return a?(0,o.sendSuccess)(r,e.t("Предложение успешно отклонено"),a):(0,o.sendError)(r,e.t("error"))}catch(e){return console.error("Error in rejectedOfferController: ",e.message),!1}}}},2668:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(2657)),a=n(t(780)),i=o.default.Router();i.post("/create",a.default.isCustomerToken,s.default.createController),i.get("/user",a.default.isCustomerToken,s.default.getApplicationByUser),i.get("/id",a.default.isCustomerToken,s.default.getApplicationByIdController),i.put("/update",a.default.isCustomerToken,s.default.updateApplication),i.post("/delete",a.default.isCustomerToken,s.default.deleteApplicationController),i.get("/list/:id",a.default.isCustomerToken,s.default.offerListController),i.get("/offer/:id_offer",a.default.isCustomerToken,s.default.getOfferByIdController),i.post("/winner",a.default.isCustomerToken,s.default.makeToWinnerController),i.post("/rejected",a.default.isCustomerToken,s.default.rejectedOfferController),r.default=i},9538:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.default={applicationSchema:{type:"object",properties:{projectName:{type:"string",required:!0},isProduct:{type:["string","boolean"]},isService:{type:["string","boolean"]},description:{type:"string"},deadlines:{type:"string",required:!0},totalSum:{type:"string"},file:{type:"string"}}}}},7606:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(4664));async function s(e,r,t){try{const{rows:n}=await o.default.query("INSERT INTO public.notifications (id_user, title, message)\n       VALUES ($1, $2, $3) RETURNING *",[e,r,t]);console.log("Notification created:",n[0])}catch(e){console.error("Error creating notification: ",e.message)}}const a={create:async function(e,r,t,n,s,a,i,u){try{const c="string"==typeof t?"true"===t.toLowerCase():t,l="string"==typeof n?"true"===n.toLowerCase():n,d=u||null,{error:f,rows:E}=await o.default.query("INSERT INTO application(id_user, project_name, is_product, is_service, description, deadlines, total_sum, file_name)\n       VALUES($1, $2, $3, $4, $5, $6, $7, $8) RETURNING *;",[e,r,c,l,s,a,i,d]);return!f&&E}catch(e){return console.log("error create: ",e.message),!1}},existsProductName:async function(e,r){const{rows:t}=await o.default.query("SELECT 1 FROM application WHERE id_user = $1 AND project_name = $2 AND active = true AND is_deleted = false LIMIT 1;",[e,r]);return t.length>0},findByIdUser:async function(e){try{const{error:r,rows:t}=await o.default.query("SELECT * FROM application a WHERE a.id_user = $1 AND a.active = true AND is_deleted = false;",[e]);return!r&&t}catch(e){return console.log("error findByIdUser: ",e.message),!1}},getApplicationById:async function(e){try{const{error:r,rows:t}=await o.default.query("SELECT a.id,\n                  a.id_user,\n                TRIM(u.surname || ' ' || u.name || ' ' || COALESCE(u.patronymic, '')) AS full_name,\n                u.company_name,\n                a.description ,\n                a.deadlines,\n                a.total_sum \n        FROM application a \n        JOIN \"user\" u ON u.id_user = a.id_user \n        WHERE a.id = $1 AND a.active = true AND a.is_deleted = false\n        LIMIT 1;\n  ",[e]);return!r&&t}catch(e){return console.log("error getUserById: ",e.message),!1}},updateApplicationData:async function(e,r,t,n,s,a,i,u){try{const c=u&&u.length>0?u.join(","):null,{error:l,rows:d}=await o.default.query("UPDATE public.application\n         SET project_name = COALESCE(NULLIF($2, ''), project_name),\n             is_product = COALESCE($3, is_product),\n             is_service = COALESCE($4, is_service),\n             description = COALESCE(NULLIF($5, ''), description),\n             deadlines = COALESCE(NULLIF($6, ''), deadlines),\n             total_sum = COALESCE(NULLIF($7, ''), total_sum),\n             file_name = COALESCE(NULLIF($8, ''), file_name),\n             updated_date = timezone('Asia/Bishkek', now())\n         WHERE id = $1\n         RETURNING *;",[e,r,t,n,s,a,i,c]);return!l&&d[0]}catch(e){return console.log("error updateApplicationData: ",e.message),!1}},deleteApplication:async function(e){try{const{rows:r}=await o.default.query("UPDATE application a \n       SET is_deleted = true,\n           active = false\n       WHERE a.id = $1\n       RETURNING id;",[e]);return r[0]}catch(e){return console.error("Error deleteApplication: ",e.message),!1}},offerList:async function(e){try{const{error:r,rows:t}=await o.default.query('SELECT u.company_name, o.* FROM offer o join "user" u USing(id_user) WHERE o.id_application = $1 AND o.active = true AND o.is_winner = false;',[e]);return!r&&t}catch(e){return console.error("Error offerList: ",e.message),!1}},offerCount:async function(e){try{const{error:r,rows:t}=await o.default.query("SELECT count(*) FROM offer o \n       WHERE id_application = $1\n       AND o.active = true \n       AND o.is_winner = false;",[e]);return!r&&t[0].count}catch(e){return console.error("Error offerCount: ",e.message),!1}},getOfferById:async function(e){try{const{error:r,rows:t}=await o.default.query('SELECT u.company_name, u.bin, o.* FROM offer o JOIN "user" u USING(id_user) WHERE o.id_offer = $1 AND o.active = true;',[e]);return!r&&t}catch(e){return console.error("Error getOfferById: ",e.message),!1}},makeToWinner:async function(e){try{const{error:r,rows:t}=await o.default.query("UPDATE public.offer\n          SET is_winner = true,\n              updated_date = now()\n       WHERE id_offer = $1\n       RETURNING *;",[e]);if(r||!t.length)return!1;const n=t[0].id_user,a="Вы выиграли",i="Поздравляем вас, вы выбраны победителем в тендере. Перейдите чтобы узнать больше.";return await s(n,a,i),t}catch(e){return console.error("Error makeToWinner: ",e.message),!1}},updateApplicationWinner:async function(e){try{const{error:r,rows:t}=await o.default.query("UPDATE public.application\n       SET has_winner = true,\n           updated_date = now()\n       WHERE id = $1\n       RETURNING *;",[e]);return!r&&t}catch(e){return console.error("Error updateApplicationWinner: ",e.message),!1}},rejectedOffer:async function(e){try{const{error:r,rows:t}=await o.default.query("UPDATE public.offer\n       SET active = false,\n           updated_date = now()\n       WHERE id_offer = $1\n       RETURNING *;",[e]);if(r||!t.length)return!1;const n=t[0].id_user,a="Ваша заявка отклонена",i="К сожалению, ваша заявка на тендер была отклонена. Спасибо за участие.";return await s(n,a,i),t}catch(e){return console.error("Error rejectedOffer: ",e.message),!1}},createNotification:s,getWinnerByIdApplication:async function(e){try{const{error:r,rows:t}=await o.default.query("    SELECT \n                  a.has_winner,\n                  creator.surname || ' ' || creator.\"name\" || ' ' || creator.patronymic AS creator_fio,\n                  creator.company_name AS creator_company_name,\n                  a.description,\n                  a.deadlines AS application_deadlines,\n                  a.total_sum AS application_total_sum,\n                  winner.surname || ' ' || winner.\"name\" || ' ' || winner.patronymic AS winner_fio,\n                  winner.company_name AS winner_company_name,\n                  winner.email AS winner_email,\n                  winner.phone AS winner_phone,\n                  o.total_sum AS winner_total_sum,\n                  o.deadlines AS winner_deadlines,\n                  o.conditions AS winner_conditions\n              FROM application a\n              JOIN \"user\" creator ON creator.id_user = a.id_user\n              LEFT JOIN offer o ON o.id_application = a.id\n              LEFT JOIN \"user\" winner ON winner.id_user = o.id_user\n              WHERE a.id = $1 AND a.active = true\n              LIMIT 1;",[e]);return!r&&t}catch(e){return console.error("Error getWinnerByIdApplication: ",e.message),!1}},existWinner:async function(e){try{const{rows:r}=await o.default.query("SELECT EXISTS(SELECT 1 FROM application a WHERE a.id = $1 AND a.active = true AND a.has_winner = true LIMIT 1);",[e]);return r[0].exists}catch(e){return console.log("error existWinner: ",e.message),!1}},getIdUserByApplication:async function(e){try{const{rows:r}=await o.default.query("SELECT id_user FROM application a WHERE a.id = $1 AND a.active = true LIMIT 1;",[e]);return r}catch(e){return console.log("error getIdUserByApplication: ",e.message),!1}}};r.default=a},5291:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(2668));r.default=o.default},4797:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(8549),s=t(4572),a=n(t(8416)),i=n(t(7914)),u=n(t(4086));r.default=new class{async verificationEmail(e,r){try{if(!(0,a.default)(e.body,u.default.verificationSchema))return(0,s.sendError)(r,e.t("inValidFormat"));const{email:t}=e.body,n=String(t).toLocaleLowerCase();if(!(0,o.isValidEmail)(n))return(0,s.sendError)(r,e.t("noValidEmail"));if(await i.default.isEmailUsed(t))return(0,s.sendError)(r,e.t("emailUsed"));if(await i.default.existCodeEmail(n))return(0,s.sendError)(r,e.t("isExistEmailCode"));const c=(0,o.generateCode)();if(!c)return(0,s.sendError)(r,e.t("errorGenerateCode"));const l=String(c),d=await i.default.emailConfirmCode(n,l);if(d){const t="object"==typeof d&&(null==d?void 0:d.status)?d.status:null;return await i.default.insertEmailService(n,t,l),(0,s.sendSuccess)(r,e.t("codeConfirmSuccess"))}return(0,s.sendError)(r,e.t("errorSendEmail"))}catch(t){return console.log("error verificationEmail: ",t.message),(0,s.sendError)(r,e.t("error"))}}}},7832:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(4797)),a=o.default.Router();a.post("/verification",s.default.verificationEmail),r.default=a},4086:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0});r.default={verificationSchema:{type:"object",properties:{email:{type:"string",required:!0,minLength:4,maxLength:40}}}}},7914:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(2250),s=n(t(5260)),a=n(t(4664)),i={emailConfirmCode:async function(e,r){try{const t=s.default.EMAIL_TYPE_CONFIRM,n=`<div>\n                        <p>Здравствуйте! Чтобы подтвердить свой адрес электронной почты, введите этот код: ${r}</p>\n                        <p>Данное сообщение было сгенерированно в системе.<br />\n                            Ответ на это письмо не требуется.</p>\n                    </div>`;return await(0,o.emailSendService)({email:e,type:t,message:n})}catch(e){return console.log("error emailConfirmCode: ",e.message),!1}},insertEmailService:async function(e,r,t){try{const{error:n,rows:o}=await a.default.query("INSERT INTO email_verification (email, id_status, code) \n        VALUES ($1, $2, $3)\n        RETURNING email, id_status, create_date;",[e,r,t]);return!n&&o[0]}catch(e){return console.log("error insertEmailService: ",e.message),!1}},existCodeEmail:async function(e,r=5){try{const{rows:t}=await a.default.query("SELECT EXISTS(SELECT 1 FROM email_verification es \n          WHERE es.email = $1 AND es.active = TRUE\n            AND es.create_date >= CURRENT_TIMESTAMP - INTERVAL '1 minutes' * $2);",[e,r]);if(t.length>0){const{exists:e}=t[0];return e}return!1}catch(e){return console.log("error existCodeEmail: ",e.message),!1}},getCodeByEmail:async function(e,r,t=20){try{const{error:n,rows:o}=await a.default.query("SELECT es.id_email_verification, es.email, es.code \n        FROM email_verification es \n        WHERE es.email = $1 \n          AND es.active = TRUE \n          AND es.code = $2\n          AND es.create_date >= CURRENT_TIMESTAMP - INTERVAL '1 minutes' * $3\n          LIMIT 1;",[e,r,t]);return!n&&o}catch(e){return console.log("error getCodeByEmail: ",e.message),!1}},updateEmailVerificationById:async function(e){try{const{error:r,rows:t}=await a.default.query("UPDATE email_verification SET active = FALSE, update_date = CURRENT_TIMESTAMP \n        WHERE id_email_verification = $1 RETURNING id_email_verification;",[e]);return!r&&t[0]}catch(e){return console.log("error updateEmailVerificationById: ",e.message),!1}},existLinkRecoverEmail:async function(e,r=5){try{const{rows:t}=await a.default.query("SELECT EXISTS(SELECT 1 FROM recover_password_email rpe\n        WHERE rpe.email = $1 AND rpe.active = TRUE\n          AND rpe.create_date >= CURRENT_TIMESTAMP - INTERVAL '1 minutes' * $2);",[e,r]);if(t.length>0){const{exists:e}=t[0];return e}return!1}catch(e){return console.log("error existLinkRecoverEmail: ",e.message),!1}},insertRecoverPassword:async function(e){try{const{error:r,rows:t}=await a.default.query("INSERT INTO recover_password_email (email, create_date) VALUES($1, CURRENT_TIMESTAMP)\n        RETURNING id_recover_password_email;",[e]);return!r&&t[0]}catch(e){return console.log("error insertRecoverPassword: ",e.message),!1}},updatedRecoverPassStatus:async function(e,r=null){try{const{error:t,rows:n}=await a.default.query("UPDATE recover_password_email SET id_status = $2\n        WHERE id_recover_password_email = $1\n        RETURNING id_recover_password_email;",[e,r]);return!t&&n}catch(e){return console.log("error updatedRecoverPassStatus",e.message),!1}},existRecoverEmailById:async function(e,r){try{const{rows:t}=await a.default.query("SELECT EXISTS(SELECT 1 FROM recover_password_email rpe\n        WHERE rpe.id_recover_password_email = $1 AND rpe.email = $2 AND rpe.active = TRUE);",[e,r]);if(t.length>0){const{exists:e}=t[0];return e}return!1}catch(e){return console.log("error existRecoverEmailById: ",e.message),!1}},updateRecoverActive:async function(e){try{const{error:r,rows:t}=await a.default.query("UPDATE recover_password_email SET active = FALSE, update_date = CURRENT_TIMESTAMP\n        WHERE id_recover_password_email = $1\n        RETURNING id_recover_password_email;",[e]);return!r&&t}catch(e){return console.log("error updateRecoverActive: ",e.message),!1}},isEmailUsed:async function(e){try{const{error:r,rows:t}=await a.default.query('SELECT EXISTS(SELECT 1 FROM "user" WHERE email = $1);',[e]);if(r)return console.log("Error querying database for email check: ",r.message),!1;if(t.length>0){const{exists:e}=t[0];return e}}catch(e){return console.log("error IsEmailExists: ",e.message),!1}}};r.default=i},9237:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7832));r.default=o.default},6565:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(4572),s=n(t(8416)),a=n(t(1218)),i=n(t(5934));r.default=new class{async createOfferController(e,r){var t;try{if(!(0,s.default)(e.body,i.default.executorSchema))return(0,o.sendError)(r,e.t("inValidFormat"));const{id_application:n,total_sum:u,deadlines:c,conditions:l}=e.body,d=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!d)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));if(await a.default.isWinnerExist(n))return(0,o.sendError)(r,e.t("По данному тендеру уже выбран исполнитель!"));if(await a.default.isOfferExists(d,n))return(0,o.sendError)(r,e.t("Вы уже отправили предложение для этого тендера!"));const f=await a.default.createOffer(d,n,u,c,l);return f?(0,o.sendSuccess)(r,e.t("Ваша предложение успешно создано!"),f):(0,o.sendError)(r,e.t("error"))}catch(t){return console.log("error createOfferController: ",t.message),(0,o.sendError)(r,e.t("error"))}}async getAllTenderController(e,r){try{const t=await a.default.getAllTender();return t?(0,o.sendSuccess)(r,e.t("success"),t):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error getAllTenderController: ",e.message),!1}}async getTenderByIdController(e,r){var t;try{const{id:n}=e.params,s=Number(null===(t=e.user)||void 0===t?void 0:t.id),i=Number(n);let u;return u=await a.default.existOffer(s,i)?await a.default.getTender(s,i):await a.default.getTenderById(s,i),u?(0,o.sendSuccess)(r,e.t("success"),u):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error getTenderByIdController: ",e.message),!1}}async makeToFavouriteController(e,r){var t;try{const{id:n}=e.body,s=Number(n),i=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!i)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const u=await a.default.makeToFavourite(i,s);return u?(0,o.sendSuccess)(r,e.t("success"),u[0]):(0,o.sendError)(r,e.t("Уже добавлено в избранное"))}catch(e){return console.log("error makeToFavouriteController: ",e.message),!1}}async deleteToFavouriteController(e,r){var t;try{const{id:n}=e.body,s=Number(n),i=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!i)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const u=await a.default.deleteToFavourite(i,s);return u?(0,o.sendSuccess)(r,e.t("success"),u[0]):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error makeToFavouriteController: ",e.message),!1}}async favouritesListController(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await a.default.favouritesList(n);return s?(0,o.sendSuccess)(r,e.t("success"),s):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error favouritesListController: ",e.message),!1}}async getUserNotificationsController(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await a.default.getUserNotifications(n);return s?(0,o.sendSuccess)(r,e.t("success"),s):(0,o.sendError)(r,e.t("error"))}catch(e){return console.error("Error in getUserNotificationsController: ",e.message),r.status(500).json({message:"Ошибка при получении уведомлений"})}}async markAsRead(e,r){var t;try{const n=Number(e.params.id);if(!Number(null===(t=e.user)||void 0===t?void 0:t.id))return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await a.default.markAsRead(n);return s?r.status(200).json({message:"Уведомление помечено как прочитанное",data:s}):r.status(404).json({message:"Уведомление не найдено"})}catch(e){return console.error("Error in markAsRead: ",e.message),r.status(500).json({message:"Ошибка при обновлении уведомления"})}}async offerList(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await a.default.getAllOfferByIdUser(n);return console.log(s),s?(0,o.sendSuccess)(r,e.t("success"),s):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error offerList: ",e.message),!1}}async myOfferListController(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await a.default.myOfferList(n);return s?(0,o.sendSuccess)(r,e.t("success"),s):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error favouritesListController: ",e.message),!1}}async offerByIdController(e,r){var t;try{const{id_offer:n}=e.query,s=Number(n),i=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!i)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));let u;return u=await a.default.existWinner(s)?await a.default.offerById(s,i):await a.default.offerNotWinnerById(s,i),u?(0,o.sendSuccess)(r,e.t("success"),u):(0,o.sendError)(r,e.t("error"))}catch(e){return console.log("error favouritesListController: ",e.message),!1}}}},1664:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(780)),a=n(t(6565)),i=o.default.Router();i.post("/create",s.default.isExecutorToken,a.default.createOfferController),i.get("/list",a.default.getAllTenderController),i.get("/history",s.default.isExecutorToken,a.default.offerList),i.get("/favourite/list",s.default.isExecutorToken,a.default.favouritesListController),i.get("/my-offers",s.default.isExecutorToken,a.default.myOfferListController),i.get("/offer",s.default.isExecutorToken,a.default.offerByIdController),i.get("/:id",s.default.isNotEmpToken,a.default.getTenderByIdController),i.post("/favourite",s.default.isExecutorToken,a.default.makeToFavouriteController),i.post("/favourite/canceled",s.default.isExecutorToken,a.default.deleteToFavouriteController),i.post("/notifications",s.default.isNotEmpToken,a.default.getUserNotificationsController),i.patch("/read/:id",s.default.isNotEmpToken,a.default.markAsRead),r.default=i},5934:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.default={executorSchema:{type:"object",properties:{total_sum:{type:"string",required:!0},deadlines:{type:"string",required:!0},conditions:{type:"string",required:!0}}}}},1218:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7606)),s=n(t(4664)),a={createOffer:async function(e,r,t,n,a){try{const{error:i,rows:u}=await s.default.query("INSERT INTO offer(id_user, id_application, total_sum, deadlines, conditions)\n       VALUES($1, $2, $3, $4, $5)\n       RETURNING *;",[e,r,t,n,a]);if(i||!u.length)return!1;const c=r,l=await o.default.getIdUserByApplication(c),d="Новая заявка",f="По вашему тендеру пришла новая заявка, ознакомьтесь.";return l&&await o.default.createNotification(l[0].id_user,d,f),u}catch(e){return console.log("error createOffer: ",e.message),!1}},getAllTender:async function(){try{const{error:e,rows:r}=await s.default.query("SELECT * FROM application a WHERE a.active = true AND a.is_deleted = false ORDER BY created_date DESC;",[]);return!e&&r}catch(e){return console.log("error getAllTender: ",e.message),!1}},getTenderById:async function(e,r){try{const{error:t,rows:n}=await s.default.query("SELECT \n        TRIM(u.surname || ' ' || u.name || ' ' || COALESCE(u.patronymic, '')) AS full_name,\n        u.company_name,\n        a.id,\n        a.id_user,\n        a.project_name,\n        a.is_product,\n        a.is_service,\n        a.description,\n        a.deadlines,\n        a.total_sum,\n        a.created_date,\n        a.updated_date,\n        a.active,\n        a.is_deleted,\n        a.file_name,\n        COALESCE(\n          (SELECT 1 FROM favourites f WHERE f.id_user = $1 AND f.id_application = a.id LIMIT 1),\n          NULL\n        ) IS NOT NULL AS is_favorites,\n        a.has_winner\n      FROM application a\n      JOIN \"user\" u USING(id_user)\n      WHERE a.id = $2",[e,r]);return!t&&Object.assign(Object.assign({},n[0]),{file_name:`http://195.49.215.146/uploads/file-${n[0].file_name}`})}catch(e){return console.log("error getTenderById: ",e.message),!1}},makeToFavourite:async function(e,r){try{const{error:t,rows:n}=await s.default.query("INSERT INTO public.favourites (id_user, id_application)\n       VALUES ($1, $2)\n       RETURNING id_user;",[e,r]);return!t&&n}catch(e){return console.log("error makeToFavourite: ",e.message),!1}},deleteToFavourite:async function(e,r){try{const{error:t,rows:n}=await s.default.query("DELETE FROM public.favourites\n       WHERE id_user = $1 AND id_application = $2\n       RETURNING id_user;",[e,r]);return!t&&n}catch(e){return console.log("error deleteToFavourite: ",e.message),!1}},favouritesList:async function(e){try{const{error:r,rows:t}=await s.default.query("SELECT * FROM favourites f JOIN application a ON a.id = f.id_application WHERE f.id_user = $1 ORDER BY f.id DESC",[e]);return!r&&t}catch(e){return console.log("error favouritesList: ",e.message),!1}},getUserNotifications:async function(e){try{const{error:r,rows:t}=await s.default.query("SELECT *\n       FROM notifications \n       WHERE id_user = $1 ORDER BY created_at DESC",[e]);return!r&&t}catch(e){return console.error("Error fetching user notifications: ",e.message),!1}},markAsRead:async function(e){try{const{rows:r}=await s.default.query("UPDATE notifications\n       SET is_read = true, updated_at = CURRENT_TIMESTAMP\n       WHERE id_notification = $1 RETURNING *",[e]);return r[0]}catch(e){throw console.error("Error marking notification as read: ",e.message),e}},isOfferExists:async function(e,r){try{const{rows:t}=await s.default.query("SELECT EXISTS(SELECT 1 FROM offer WHERE id_user = $1 AND id_application = $2 AND active = true LIMIT 1)",[e,r]);return t[0].exists}catch(e){return console.log("error isOfferExists: ",e.message),!1}},isWinnerExist:async function(e){try{const{rows:r}=await s.default.query("SELECT EXISTS(SELECT 1 FROM application a WHERE id = $1 AND active = true AND has_winner = true LIMIT 1)",[e]);return r[0].exists}catch(e){return console.log("error isWinnerExist: ",e.message),!1}},getAllOfferByIdUser:async function(e){try{const{error:r,rows:t}=await s.default.query("SELECT * FROM offer o WHERE o.id_user = $1",[e]);return!r&&t}catch(e){return console.log("error getAllOfferByIdUser: ",e.message),!1}},existOffer:async function(e,r){try{const{rows:t}=await s.default.query("SELECT EXISTS(SELECT 1 FROM offer o WHERE id_user = $1 AND id_application = $2 AND active = true LIMIT 1);",[e,r]);return t[0].exists}catch(e){return console.log("error existOffer: ",e.message),!1}},getTender:async function(e,r){try{const{error:t,rows:n}=await s.default.query("SELECT \n        TRIM(u.surname || ' ' || u.name || ' ' || COALESCE(u.patronymic, '')) AS full_name,\n        u.company_name,\n        a.id,\n        a.id_user,\n        a.project_name,\n        a.is_product,\n        a.is_service,\n        a.description,\n        a.deadlines,\n        a.total_sum,\n        a.created_date,\n        a.updated_date,\n        false AS active,\n        a.is_deleted,\n        a.file_name,\n        COALESCE(\n          (SELECT 1 FROM favourites f WHERE f.id_user = $1 AND f.id_application = a.id LIMIT 1),\n          NULL\n        ) IS NOT NULL AS is_favorites,\n        a.has_winner\n      FROM application a\n      JOIN \"user\" u USING(id_user)\n      WHERE a.id = $2",[e,r]);return!t&&Object.assign(Object.assign({},n[0]),{file_name:n[0].file_name?`http://195.49.215.146/uploads/file-${n[0].file_name}`:null})}catch(e){return console.log("error getTender: ",e.message),!1}},myOfferList:async function(e){try{const{error:r,rows:t}=await s.default.query("SELECT o.is_winner , o.id_offer, a.* FROM offer o \n        LEFT JOIN application a ON a.id = o.id_application \n        WHERE o.id_user = $1 AND o.active = true;",[e]);return!r&&t}catch(e){return console.log("error myOfferList: ",e.message),!1}},offerNotWinnerById:async function(e,r){try{const{error:t,rows:n}=await s.default.query("       SELECT \n                  o.is_winner,\n                  creator.surname || ' ' || creator.\"name\" || ' ' || creator.patronymic AS creator_fio,\n                  creator.company_name AS creator_company_name,\n                  a.description,\n                  a.deadlines AS application_deadlines,\n                  a.total_sum AS application_total_sum\n              FROM offer o\n              JOIN \"user\" creator ON creator.id_user = o.id_user\n              LEFT JOIN application a ON o.id_application = a.id\n              WHERE o.id_offer = $1 and o.id_user = $2 AND o.active = true\n              LIMIT 1;",[e,r]);return!t&&n[0]}catch(e){return console.error("Error offerNotWinnerById: ",e.message),!1}},offerById:async function(e,r){try{const{error:t,rows:n}=await s.default.query('        SELECT \n                  o.is_winner,\n                  creator.surname || \' \' || creator."name" || \' \' || creator.patronymic AS creator_fio,\n                  creator.company_name AS creator_company_name,\n                  a.description,\n                  a.deadlines AS application_deadlines,\n                  a.total_sum AS application_total_sum,\n                  customer.email AS customer_email,\n                  customer.phone AS customer_phone\n              FROM offer o\n              JOIN "user" creator ON creator.id_user = o.id_user\n              LEFT JOIN application a ON o.id_application = a.id\n              left join "user" customer on customer.id_user = a.id_user \n              WHERE o.id_offer = $1 and o.id_user = $2 AND o.active = true\n              LIMIT 1;',[e,r]);return!t&&n[0]}catch(e){return console.error("Error offerById: ",e.message),!1}},existWinner:async function(e){try{const{rows:r}=await s.default.query("SELECT EXISTS(SELECT 1 FROM offer o WHERE o.id_offer = $1 AND o.active = true AND o.is_winner = true LIMIT 1);",[e]);return r[0].exists}catch(e){return console.log("error existWinner: ",e.message),!1}},getOfferByIdUserAndApp:async function(e,r){try{const{rows:t}=await s.default.query("SELECT id_offer FROM offer o WHERE o.id_user = $1 and o.id_application = $2 AND o.active = true LIMIT 1;",[e,r]);return t[0]}catch(e){return console.log("error getOfferByIdUserAndApp: ",e.message),!1}}};r.default=a},6670:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(1664));r.default=o.default},7806:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(7174)),a=n(t(6898)),i=n(t(8577)),u=n(t(6376)),c=n(t(2320)),l=n(t(218)),d=n(t(5260)),f=n(t(3978)),E=n(t(4251)),p=n(t(2652)),_=t(4664),m=n(t(6799)),y=n(t(2710)),g=(0,o.default)();(async()=>{try{const e=d.default.PORT;g.use("/doc",c.default.serve,c.default.setup(y.default)),g.use((0,i.default)(E.default)),g.use(p.default),g.use(f.default),g.use(o.default.json()),g.use((0,s.default)()),g.use((0,a.default)()),g.use((0,u.default)()),g.use(m.default),g.use("/",o.default.static("public")),g.use("/",l.default),g.listen(e,(async()=>{console.log("Application listening on port: ",e),await(0,_.connectionCheck)()}))}catch(e){console.log("error startServer: ",e.message)}})()},2118:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(6432));r.default=o.default},6837:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(4572),s=n(t(8416)),a=n(t(1694)),i=n(t(5106)),u=t(8549),c=n(t(7914)),l=n(t(5574)),d=n(t(3481)),f=n(t(5260)),E=n(t(540));r.default=new class{async register(e,r){try{if(!(0,s.default)(e.body,a.default.registerSchema))return(0,o.sendError)(r,e.t("inValidFormat"));const{company_name:t,bin:n,surname:l,name:d,patronymic:f,email:E,phone:p,id_role:_}=e.body,m=String(E).toLocaleLowerCase();if(!(0,u.isValidEmail)(m))return(0,o.sendError)(r,e.t("noValidEmail"));if(await i.default.isEmailExist(m,_))return(0,o.sendError)(r,e.t("register.emailExist"));const y=3===_?3:2,g=await i.default.insertUser(t,n,l,d,f||"",m,p,y);if(g){const t=(0,u.generateCode)();if(!t)return(0,o.sendError)(r,e.t("errorGenerateCode"));const n=String(t),s=await c.default.emailConfirmCode(m,n);if(s){const t="object"==typeof s&&(null==s?void 0:s.status)?s.status:null;return await c.default.insertEmailService(m,t,n),(0,o.sendSuccess)(r,e.t("success"),g)}return(0,o.sendError)(r,e.t("errorSendEmail"))}return!1===g?(0,o.sendError)(r,e.t("register.dbInsertChallengerError")):(0,o.sendError)(r,e.t("register.unknownError"))}catch(t){return console.log("register: ",t.message),(0,o.sendError)(r,e.t("register.tryError"))}}async verification(e,r){var t;try{if(!(0,s.default)(e.body,a.default.emailVerificationSchema))return(0,o.sendError)(r,e.t("inValidFormat"));const{id_user:n,code:i}=e.body,u=await l.default.getEmailById(n);if(!u)return(0,o.sendError)(r,e.t("email не найден"));const d=String(u),f=await c.default.getCodeByEmail(d,i);if(!f)return(0,o.sendError)(r,e.t("register.errorCheckEmailCode"));const E=null===(t=f[0])||void 0===t?void 0:t.id_email_verification;return E?E>0?(await c.default.updateEmailVerificationById(E),await l.default.updateUser(n),(0,o.sendSuccess)(r,e.t("success"),n)):(0,o.sendError)(r,e.t("register.unknownError")):(0,o.sendError)(r,e.t("register.errorCheckEmailCode"))}catch(t){return console.log("register: ",t.message),(0,o.sendError)(r,e.t("register.tryError"))}}async insertPasswordController(e,r){try{const{id_user:t,password:n,confirmPassword:s}=e.body;if(!n||n.length<6)return(0,o.sendError)(r,e.t("register.errorPassLength"));if(n!==s)return(0,o.sendError)(r,e.t("register.errorPassword"));const a=await i.default.insertPassword(t,n),u=await l.default.getPhoneByUserId(a);console.log(u);const c=await l.default.userLogin(u,n);if(c&&c.role){const t=Date.now()+60*parseInt(f.default.JWT_EXPIRE_HOURS)*60*1e3,n=Array.isArray(c.role)?c.role:[c.role],s=d.default.generateAccessToken({id:c.id,r:n,s:c.surname,n:c.name,p:c.patronymic,exp:t});if(!s)return(0,o.sendError)(r,e.t("token.generateError"));const a="Bearer "+s,i=await E.default.LOGIN(e,r,String(u),c.id,n,a);if(c&&i)return(0,o.sendSuccess)(r,e.t("success"),{authState:{id:c.id,s:c.surname,n:c.name,p:c.patronymic,r:n,exp:t},token:s,tokenType:"Bearer",expiresIn:60*parseInt(f.default.JWT_EXPIRE_HOURS)})}return(0,o.sendError)(r,e.t("unauth"),!1,401)}catch(e){return console.log("error insertPasswordController: ",e.message),!1}}}},6432:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(6837)),a=o.default.Router();a.post("/user",s.default.register),a.post("/verification",s.default.verification),a.post("/password",s.default.insertPasswordController),r.default=a},1694:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.default={registerSchema:{type:"object",properties:{company_name:{type:"string",required:!0},bin:{type:"string",required:!0},surname:{type:"string",minLength:1,maxLength:100,required:!0},name:{type:"string",minLength:1,maxLength:100,required:!0},patronymic:{type:["string","null"]},email:{type:"string",minLength:4,maxLength:100,required:!0},phone:{type:"string",minLength:1,required:!0},id_role:{type:"number",required:!0}}},emailVerificationSchema:{type:"object",properties:{id_user:{type:"number",required:!0},code:{type:"number",required:!0}}}}},5106:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(4664)),s=t(7265),a={isBinExist:async function(e){try{const{rows:r}=await o.default.query('SELECT EXISTS(SELECT 1 FROM "user" WHERE "user".bin=$1 AND "user".check_cod=true);',[e]);if(r.length>0){const{exists:e}=r[0];return e}return!1}catch(e){return console.log("error isPinExist: ",e.message),!1}},isEmailExist:async function(e,r){try{const{rows:t}=await o.default.query('SELECT EXISTS(SELECT 1 FROM "user" u\n                     JOIN user_role ur USING(id_user)\n                     WHERE u.email = $1 AND u.active = true AND ur.id_role = $2);',[e,r]);if(t.length>0){const{exists:e}=t[0];return e}return!1}catch(e){return console.log("error isEmailExist: ",e.message),!1}},insertUser:async function(e,r,t,n,s,a,i,u){try{const c=2===u?2:3,{rows:l}=await o.default.query('SELECT id_user FROM "user" WHERE email = $1 AND phone = $2',[a,i]);if(l.length>0){const e=l[0].id_user,{rows:r}=await o.default.query("SELECT * FROM user_role WHERE id_user = $1 AND id_role = $2",[e,c]);return 0===r.length&&await o.default.query("INSERT INTO user_role (id_user, id_role) VALUES ($1, $2)",[e,c]),{id_user:e}}{const{rows:u,error:l}=await o.default.query('WITH inserted_user AS (\n          INSERT INTO "user" \n            (company_name, bin, surname, name, patronymic, email, phone, created_date, active, deleted) \n          VALUES ($1, $2, $3, $4, $5, $6, $7, CURRENT_TIMESTAMP, false, false) \n          RETURNING id_user\n        )\n        INSERT INTO user_role (id_user, id_role)\n        VALUES ((SELECT id_user FROM inserted_user), $8)\n        RETURNING id_user;',[e,r,t,n,s,a,i,c]);return!l&&u[0]}}catch(e){return console.log("error insertUser: ",e.message),!1}},isPhoneExist:async function(e){try{const{rows:r}=await o.default.query('SELECT EXISTS(\n        SELECT 1 FROM "user"\n        WHERE "user".phone LIKE $1);',[`%${e}`]);if(r.length>0){const{exists:e}=r[0];return e}return!1}catch(e){return console.log("error isPhoneExist: ",e),!1}},formatPhoneNumber:function(e){const r=e.replace(/[^\d]/g,"");return r.startsWith("996")?r.slice(4):r.startsWith("0")?r.slice(1):r},insertPassword:async function(e,r){try{const t=(0,s.md5)(r),{error:n,rows:a}=await o.default.query('UPDATE "user" SET password = $2\n       WHERE "user".id_user = $1\n       RETURNING id_user;',[e,t]);return!n&&a[0].id_user}catch(e){return console.log("error insertPassword: ",e.message),!1}}};r.default=a},6799:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(7252),s=n(t(5684)),a=n(t(9237)),i=n(t(2118)),u=n(t(5291)),c=n(t(6670)),l=n(t(3946)),d=(0,o.Router)().use("/user",s.default).use("/email",a.default).use("/register",i.default).use("/application",u.default).use("/executor",c.default).use("/admin",l.default);d.use(((e,r)=>{r.status(404).json({error:"API not found"})})),r.default=(0,o.Router)().use("/tender/api",d)},780:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(4572),s=n(t(5260)),a=n(t(3481)),i=n(t(540)),u=(e,r)=>(0,o.sendError)(e,r,!1,401),c=async(e,r,t,n)=>{try{const o=e.cookies[s.default.COOKIE_ACCESS],c=e.headers.authorization||(o?`Bearer ${o}`:"");if("development"===s.default.NODE_ENV&&console.log("token: ",c),e.token=c,c){const o=a.default.getTokenData(c);if(!o)return u(r,e.t("token.invalid"));const l=Date.now();if("development"===s.default.NODE_ENV&&(console.log(Object.assign({},o)),console.log(new Date(o.exp)),console.log(new Date(l)),console.log(o.exp>l)),await i.default.CHECK_PERM(e)&&c&&o&&o.exp>l){const s=o.r.map((e=>e.id_role));return await(async(e,r)=>{const t=new Set(e);for(let e of r)if(t.has(e))return!0;return!1})(s,n)?(e.user=o,t()):u(r,e.t("token.permission"))}return u(r,e.t("token.invalid"))}return u(r,e.t("token.notFound"))}catch(t){return console.log("CheckUser error catch =>",t),u(r,e.t("token.expired"))}},l={isAdminToken:async(e,r,t)=>await c(e,r,t,[1]),isCustomerToken:async(e,r,t)=>await c(e,r,t,[1,2]),isExecutorToken:async(e,r,t)=>await c(e,r,t,[1,3]),isNotEmpToken:async(e,r,t)=>await c(e,r,t,[1,2,3])};r.default=l},5946:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(5560)),s={saveFile:async function({path:e,fileName:r,sampleFile:t,ALLOWED_EXTENSIONS:n=["pdf","docx","doc","xlsx","jpg","jpeg","png"],type:o,allowTypePrefix:s=!0}){var a;try{const i=null===(a=t.name.split(".").pop())||void 0===a?void 0:a.toLowerCase();if(!i)return{error:!0,dbFileName:""};if(!n.includes(i))return{error:!0,dbFileName:""};const u=t.mimetype,c={image:["image/jpeg","image/png","image/jpg"],file:["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]};if("image"===o&&!c.image.includes(u))return{error:!0,dbFileName:""};if("file"===o&&!c.file.includes(u))return{error:!0,dbFileName:""};const l=`${r}.${i}`,d=`${e}${s?`${o}-`:""}${l}`;return await t.mv(d),{error:!1,dbFileName:l}}catch(e){return console.log("error saveFile: ",e.message),{error:!0,dbFileName:""}}},removeFile:async function(e,r){o.default.deleteFile(`${e}${r}`)}};r.default=s},2250:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.emailSendService=async function({email:e,type:r,redirect:t=!1,message:n,content:a=null}){try{const{data:i,status:u}=await o.default.post(s,{email:e,type:r,redirect:t,message:n,content:a});return(200===u||201===u)&&(!(null==i?void 0:i.status)||i)}catch(e){return console.log("error emailSendService: ",e.message),!1}};const o=n(t(8938)),s=n(t(5260)).default.EMAIL_SERVICE_URL},5684:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(2828));r.default=o.default},5905:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(4572),s=n(t(8416)),a=n(t(5260)),i=n(t(3481)),u=n(t(540)),c=n(t(5574)),l=n(t(3410));r.default=new class{async login(e,r){try{if(!(0,s.default)(e.body,l.default.loginSchema))return(0,o.sendError)(r,e.t("inValidFormat"));const{password:t,login:n}=e.body,d=await c.default.userLogin(n,t);if(d&&d.role){const t=Date.now()+60*parseInt(a.default.JWT_EXPIRE_HOURS)*60*1e3,s=Array.isArray(d.role)?d.role:[d.role],c=i.default.generateAccessToken({id:d.id,r:s,s:d.surname,n:d.name,p:d.patronymic,exp:t});if(!c)return(0,o.sendError)(r,e.t("token.generateError"));const l="Bearer "+c,f=await u.default.LOGIN(e,r,String(n),d.id,s,l);if(d&&f)return(0,o.sendSuccess)(r,e.t("success"),{authState:{id:d.id,s:d.surname,n:d.name,p:d.patronymic,r:s},token:c,tokenType:"Bearer"})}return(0,o.sendError)(r,e.t("unauth"),!1,401)}catch(t){return console.log("error login: ",t.message),(0,o.sendError)(r,e.t("error"),!1,400)}}async check(e,r){try{const t=e.headers.authorization;if(!t)return(0,o.sendError)(r,e.t("noToken"),!1,401);const n=i.default.getTokenData(t);n||(0,o.sendError)(r,e.t("error"));const s=t.split(" ")[1];if(n&&n.exp>(new Date).getTime()){const t=n.r.map((e=>e.role_name));return(0,o.sendSuccess)(r,e.t("success"),{authState:{id:n.id,s:n.s,n:n.n,b:n.b,r:t,idUd:n.idUd,exp:n.exp},token:s,tokenType:"Bearer",expiresIn:(n.exp-Date.now())/6e4})}return(0,o.sendError)(r,e.t("error"),!1,401)}catch(t){return console.log("error check: ",t.message),(0,o.sendError)(r,e.t("error"))}}async logout(e,r){return await u.default.LOGOUT(e,r)?(0,o.sendSuccess)(r,e.t("success")):(0,o.sendError)(r,e.t("error"))}async getUserByIdController(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await c.default.getUserById(n);return!s||Array.isArray(s)&&0===s.length?(0,o.sendError)(r,e.t("Пользователь с таким id не найден!")):(0,o.sendSuccess)(r,e.t("success"),s[0])}catch(e){return console.log("error getUserByIdController: ",e.message),!1}}async updateUser(e,r){var t;try{const{companyName:n,bin:s,surname:a,name:i,patronymic:u,email:l,phone:d}=e.body,f=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!f)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const E=await c.default.getUserById(f);if(!E||0===E.length)return(0,o.sendError)(r,e.t("error.userNotFound"));const p=await c.default.updateUserData(f,n,s,a,i,u,l,d);return p?(0,o.sendSuccess)(r,e.t("success"),p):(0,o.sendError)(r,e.t("error"))}catch(t){return console.log("error updateUserController: ",t.message),(0,o.sendError)(r,e.t("error.unexpected"))}}async deleteUserController(e,r){var t;try{const n=Number(null===(t=e.user)||void 0===t?void 0:t.id);if(!n)return(0,o.sendError)(r,e.t("register.userNotAuthenticated"));const s=await c.default.deleteUser(n);return s?(0,o.sendSuccess)(r,e.t("Успешно удалено"),s):(0,o.sendError)(r,e.t("error"))}catch(t){return console.error("Error in deleteUserController: ",t.message),(0,o.sendError)(r,e.t("error.unexpected"))}}}},2828:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(7252)),s=n(t(5905)),a=n(t(780)),i=o.default.Router();i.post("/login",s.default.login),i.post("/check",s.default.check),i.post("/logout",s.default.logout),i.get("/find-by-id",a.default.isNotEmpToken,s.default.getUserByIdController),i.put("/update",a.default.isNotEmpToken,s.default.updateUser),i.post("/delete",a.default.isNotEmpToken,s.default.deleteUserController),r.default=i},3410:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.default={loginSchema:{type:"object",properties:{login:{type:["string","number"],required:!0,minLength:1},password:{type:"string",required:!0,minLength:1}}},forgotPasswordSchema:{type:"object",properties:{last_name:{type:"string",required:!0},email:{type:"string",required:!0}}},confirmPasswordSchema:{type:"object",properties:{password:{type:"string",required:!0},confirmPassword:{type:"string",required:!0}}},changeEmailSchema:{type:"object",properties:{email:{type:"string",minLength:4,maxLength:100,required:!0},code:{type:"string",minLength:1,required:!0}}},changeNumberSchema:{type:"object",properties:{phone:{type:"string",minLength:12,maxLength:12,required:!0}}},changePasswordSchema:{type:"object",properties:{password:{type:"string",minLength:6,required:!0},confirm_password:{type:"string",minLength:6,required:!0}}}}},5574:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(7265),s=n(t(4664)),a={userLogin:async function(e,r){try{const t=(0,o.md5)(r),{rows:n,rowCount:a}=await s.default.query("SELECT * FROM fn_auth($1, $2);",[e,t]);if(a&&a>0){const{id_user:e,bin:r,surname:t,name:o,patronymic:s,roles:a}=n[0];return{id:e,role:a,bin:r,surname:t,name:o,patronymic:s}}return!1}catch(e){return console.log("error userLogin: ",e.message),!1}},getEmailById:async function(e){try{const{error:r,rows:t}=await s.default.query('SELECT u.email FROM "user" u WHERE id_user = $1',[e]);return r?(console.log("Error querying database for get Email: ",r.message),!1):t[0].email}catch(e){return console.log("error getEmailById: ",e.message),!1}},getPasswordById:async function(e){try{const{error:r,rows:t}=await s.default.query('SELECT password FROM "user" WHERE id_user = $1;',[e]);return!r&&t[0]}catch(e){return console.log("error getPasswordById: ",e.message),!1}},getRoleById:async function(e){try{const{error:r,rows:t}=await s.default.query('SELECT u.id_role \n       FROM "user" u \n       WHERE u.id_user=$1;',[e]);return!r&&t[0].id_role}catch(e){return console.log("error quering getRoleById: ",e.message),!1}},updateUser:async function(e){try{const{error:r,rows:t}=await s.default.query('UPDATE "user" SET active_email = true WHERE id_user = $1 RETURNING id_user;',[e]);return!r&&t}catch(e){return console.log("error updateUser: ",e.message),!1}},getUserById:async function(e){try{const{error:r,rows:t}=await s.default.query("SELECT u.company_name, u.bin, \n              TRIM(u.surname || ' ' || u.name || ' ' || COALESCE(u.patronymic, '')) AS full_name,\n              u.email, u.phone\n       FROM \"user\" u \n       WHERE u.id_user = $1;",[e]);return!r&&t}catch(e){return console.log("error getUserById: ",e.message),!1}},updateUserData:async function(e,r,t,n,o,a,i,u){try{const{error:c,rows:l}=await s.default.query("UPDATE \"user\"\n       SET company_name = COALESCE(NULLIF($2, ''), company_name),\n           bin = COALESCE(NULLIF($3, ''), bin),\n           surname = COALESCE(NULLIF($4, ''), surname),\n           \"name\" = COALESCE(NULLIF($5, ''), \"name\"),\n           patronymic = COALESCE(NULLIF($6, ''), patronymic),\n           email = COALESCE(NULLIF($7, ''), email),\n           phone = COALESCE(NULLIF($8, ''), phone),\n           active = true,\n           updated_date = now()\n       WHERE id_user = $1\n       RETURNING *;",[e,r,t,n,o,a,i,u]);return!c&&l[0]}catch(e){return console.log("error updateUserData: ",e.message),!1}},deleteUser:async function(e){try{const{rows:r}=await s.default.query('UPDATE "user" \n       SET deleted = true,\n       \t   active = false\n       WHERE "user".id_user = $1\n       RETURNING id_user;',[e]);return r[0]}catch(e){return console.error("Error deleting user: ",e.message),!1}},getPhoneByUserId:async function(e){try{const{rows:r}=await s.default.query('SELECT phone FROM "user" WHERE "user".id_user = $1;',[e]);return r[0].phone}catch(e){return console.error("Error getPhoneByUserId: ",e.message),!1}},getPhoneExist:async function(e){var r;try{const{rows:t}=await s.default.query('SELECT EXISTS(SELECT 1 FROM "user" WHERE "user".phone = $1);',[e]);return null===(r=t[0])||void 0===r?void 0:r.exists}catch(e){return console.error("Error getPhoneByUserId: ",e.message),!1}}};r.default=a},5260:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),n(t(818)).default.config();const o=Number(process.env.PORT)||5e3,s=process.env.JWT_ACCESS_SECRET||"",a=process.env.JWT_EXPIRE_HOURS||"30h",i=process.env.DBUSER||"postgres",u=process.env.DBPASS||"postgres",c=process.env.DBSERVER||"localhost",l=process.env.DBPORT||5432,d=process.env.DBNAME||"postgres",f=process.env.DBNAME2||"postgres",E=process.env.DBPG_MAX_CONNECTIONS||20,p=process.env.DBPG_IDLETIMEOUTMILLLIS||3e4,_=process.env.DBPG_CONNECTIONTIMEOUTMILLES||2e3,m=Number(process.env.ID_ADMIN_ROLE)||19,y=process.env.ALLOW_HOST||`http://localhost:${o}`,g=process.env.ALLOW_HOST_LIST?JSON.parse(process.env.ALLOW_HOST_LIST):[y],h=process.env.COOKIE_MOBILE||"isMobile",S=process.env.COOKIE_ACCESS||"access_token",T=process.env.CHECK_TUNDUK||"true",v=process.env.SECURITY_SERVER_URL||"http://localhost:5000",N=process.env.SECURITY_SERVER_URL_CHILDREN||"http://localhost:5000",I=process.env.SECURITY_TUNDUK_HEADER||"header",R=process.env.SECURITY_TUNDUk_VALUE_PASSPORT||"value",C=process.env.SECURITY_TUNDUk_VALUE||"value",A=process.env.EMAIL_SERVICE_URL||"http://localhost:5000",w=process.env.EMAIL_TYPE_CONFIRM||"TYPE_CONFIRM",L=process.env.EMAIL_TYPE_RECOVER||"TYPE_RECOVER",O=process.env.EMAIL_JWT_EXPIRE_HOURSE||"1000h",U=process.env.EMAIL_TYPE_PASSWORD||"TYPE",M=process.env.URL_FORGOT_PASSWORD||"http://localhost:5000",D=process.env.STREET_SERVICE_URL||"http://localhost:5000",b=process.env.STREET_TOKEN||"token",P=process.env.STREET_FULL_PATH||"http://localhost:5000",F=process.env.ADDRESS_SERVICE_URL||"http://localhost:5000",$=process.env.SECURITY_ADDRESS_HEADER||"header",x=process.env.SECURITY_ADDRESS_VALUE||"value",q=process.env.DEFAULT_KEY_CAPTCHA||"KEY_CAPTCHA",k=process.env.SCHOOL_TOKEN||"token",B=process.env.REGISTER_AGE||18,W=process.env.FILE_PATH||"",j={PORT:o,NODE_ENV:"production",JWT_ACCESS_SECRET:s,JWT_EXPIRE_HOURS:a,DBUSER:i,DBPASS:u,DBSERVER:c,DBPORT:l,DBNAME:d,DBNAME2:f,DBPG_MAX_CONNECTIONS:E,DBPG_IDLETIMEOUTMILLLIS:p,DBPG_CONNECTIONTIMEOUTMILLES:_,ALLOW_HOST_LIST:g,COOKIE_MOBILE:h,COOKIE_ACCESS:S,CHECK_TUNDUK:T,SECURITY_SERVER_URL:v,SECURITY_SERVER_URL_CHILDREN:N,SECURITY_TUNDUK_HEADER:I,SECURITY_TUNDUk_VALUE:C,EMAIL_SERVICE_URL:A,EMAIL_TYPE_CONFIRM:w,EMAIL_TYPE_RECOVER:L,EMAIL_JWT_EXPIRE_HOURSE:O,ADDRESS_SERVICE_URL:F,SECURITY_ADDRESS_HEADER:$,SECURITY_TUNDUk_VALUE_PASSPORT:R,SECURITY_ADDRESS_VALUE:x,URL_FORGOT_PASSWORD:M,DEFAULT_KEY_CAPTCHA:q,SCHOOL_TOKEN:k,REGISTER_AGE:B,ID_ADMIN_ROLE:m,STREET_SERVICE_URL:D,STREET_TOKEN:b,STREET_FULL_PATH:P,FILE_BENEFICIARY_PATH:process.env.FILE_BENEFICIARY_PATH||"",FILE_BENEFICIARY_URL:process.env.FILE_BENEFICIARY_URL||"",EMAIL_TYPE_PASSWORD:U,FILE_KDD_PATH:process.env.FILE_KDD_PATH||"",FILE_KDD_URL:process.env.FILE_KDD_URL||"",FILE_RELATION_PATH:process.env.FILE_RELATION_PATH||"",FILE_RELATION_URL:process.env.FILE_RELATION_URL||"",ENI_SERVICE:process.env.ENI_SERVICE||"",ENI_SERVICE_TOKEN:process.env.ENI_SERVICE_TOKEN||"",FILE_PATH:W,MUGALIM_SERVICE_URL:process.env.MUGALIM_SERVICE_URL||"http://localhost:5000",MUGALIM_SERVICE_HEADER:process.env.MUGALIM_SERVICE_HEADER||"header",MUGALIM_SERVICE_VALUE:process.env.MUGALIM_SERVICE_VALUE||"value",SWAGGER_URL:process.env.SWAGGER_URL||""};r.default=j},540:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=t(3903),s=n(t(4664)),a=t(7265),i=n(t(5260)),u=o.v4,c=i.default.COOKIE_MOBILE;async function l(e,r,t,n,o){const a=JSON.stringify(t),{rowCount:i}=await s.default.query('INSERT INTO "Session_log" (login, id_user, role, log_time, is_mobile, ip)\n          VALUES ($1, $2, $3, current_timestamp, $4, $5)',[e,r,a,n,o]);return!!i}const d={LOGIN:async function(e,r,t,n,o,i){var d;const f=JSON.stringify(o),E="true"==String(e.cookies[c]),p=i||await async function(){return u()}(),_=(0,a.md5)(p),m=e.headers["x-forwarded-for"];let y;if(Array.isArray(m))y=null!==(d=m[0])&&void 0!==d?d:e.ip;else if("string"==typeof m){const r=m.split(",");y=r.length>0?r[0].trim():e.ip}else y=e.ip;const{rows:g}=await s.default.query('SELECT  EXISTS( SELECT 1 FROM "Session" WHERE login = $1);',[t]);if(g[0].exists){const{rowCount:e}=await s.default.query('UPDATE "Session"\n        SET offline=false,\n            last_action=current_timestamp,\n            cookie=$2,\n            id_user=$3,\n            is_mobile=$4,\n            role=$5\n       WHERE login=$1',[t,_,n,E,f]);return e&&await l(t,n,o,E,y),p}{const{rowCount:e}=await s.default.query('INSERT INTO "Session" (cookie, login, id_user, role, last_action, is_mobile)\n            VALUES ($1, $2, $3, $4, current_timestamp, $5)',[_,String(t),n,f,E]);return e&&await l(t,n,o,E,y),p}},LOGOUT:async function(e,r){const t=(0,a.md5)(String(e.headers.authorization)),{command:n,rowCount:o}=await s.default.query('UPDATE "Session" SET offline=true\n          WHERE offline=false AND login IN\n          (SELECT login FROM "Session" \n          WHERE cookie = $1);',[t]);return"UPDATE"==n&&{rowCount:o}},CHECK_PERM:async function(e){let r=await async function(e){const r=e.headers.authorization;if(r){const{rowCount:e,rows:t}=await s.default.query('SELECT * FROM "fn_Session_Get_User"($1);',[(0,a.md5)(r)]);if(e)return Object.assign({},t[0]);console.log(e),console.log(t[0])}return!1}(e);return e.user=r,!!r}};r.default=d},4251:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(5260));r.default=function(e,r){let t;t=-1!==o.default.ALLOW_HOST_LIST.indexOf(e.headers.origin||"")?{origin:!0,credentials:!0}:{origin:!1},r(null,t)}},9095:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(8749));var s=Buffer.from("3e10bb241d611ac910af5d8690011e6c","hex"),a=Buffer.from("34db16c275e2895654e798794f6e47ae","hex");const i="aes-128-cbc";r.default={encrypt:function(e){var r=o.default.createCipheriv(i,a,s);return r.update(e,"utf8","base64")+r.final("base64")},decrypt:function(e){var r=o.default.createDecipheriv(i,a,s);return r.update(e,"base64","utf8")+r.final("utf8")}}},4664:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.db=void 0,r.connectionCheck=async function(){try{return a.query("select 1 as answer;",[]).then((e=>{console.log("Connected to PG=>",e.rows[0]&&1==e.rows[0].answer)})).catch((e=>{throw console.error("Error executing query: ",e.stack),new Error(e)}))}catch(e){return{rows:[],rowCount:0,error:e.message}}},r.transaction=async function(e){const r=await a.connect();try{await r.query("BEGIN");const t=await e(r);return await r.query("COMMIT"),t}catch(e){throw await r.query("ROLLBACK"),e}finally{r.release()}};const o=t(2449),s=n(t(5260)),a=new o.Pool({host:s.default.DBSERVER,port:Number(s.default.DBPORT),database:s.default.DBNAME,user:s.default.DBUSER,password:s.default.DBPASS,max:Number(s.default.DBPG_MAX_CONNECTIONS),idleTimeoutMillis:Number(s.default.DBPG_IDLETIMEOUTMILLLIS),connectionTimeoutMillis:Number(s.default.DBPG_CONNECTIONTIMEOUTMILLES)});r.db=a,r.default={query:async function(e,r){try{"development"===s.default.NODE_ENV&&console.log("PG query: ",{text:e,params:r});const{rows:t,rowCount:n,command:o}=await a.query(e,r);return{rows:t,rowCount:n,error:!1,command:o}}catch(t){return console.log("PG ERROR=>",t),console.log("PG query: ",{text:e,params:r}),{rows:[],rowCount:0,error:t.message}}}}},2652:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0});const n=t(4572);r.default=(e,r,t,o)=>(console.log("errorHandler","=>",{url:r.url,error:e,tFunctionAvailable:"function"==typeof r.t}),(0,n.sendError)(t,null==e?void 0:e.message))},5560:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(9896)),s={exists:async e=>!!await o.default.promises.stat(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),!1))),deleteFile:async e=>await o.default.promises.unlink(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),!1))),listDir:async e=>await o.default.promises.readdir(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),[]))),write:async(e,r)=>await o.default.promises.writeFile(e,r,"utf8"),read:async e=>await o.default.promises.readFile(e,"utf8")};r.default=s},218:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(e,r,t){if("/"===e.originalUrl)return r.redirect("/");const n=function(){let e=__dirname;for(;;){const r=o.default.join(e,"public");if(s.default.existsSync(r)&&s.default.statSync(r).isDirectory())return r;const t=o.default.dirname(e);if(t===e)break;e=t}return null}();return n?r.sendFile(o.default.join(n,"index.html")):r.status(404).send("Public directory not found")};const o=n(t(6928)),s=n(t(9896))},8549:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.decodeFileName=function(e){return o.default.decode(Buffer.from(e,"latin1"),"utf8")},r.isValidPin=function(e){return/^[1,2](0[1-9]|[1-2][0-9]|(3)[0-1])(0[1-9]|1[0-2])(19[2-9][0-9]|20[0-9][0-9])\d{5}$/.test(e)},r.isValidEmail=function(e){return/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/.test(e)},r.generateCode=function(){return Math.floor(1e4+9e4*Math.random())},r.isValidDate=function(e){if(!/^\d{2}-\d{2}-\d{4}$/.test(e))return!1;var r=e.split("-"),t=parseInt(r[0],10),n=parseInt(r[1],10),o=parseInt(r[2],10),s=new Date(o,n-1,t);return s.getFullYear()===o&&s.getMonth()===n-1&&s.getDate()===t};const o=n(t(7868))},3978:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(6427)),s=n(t(8495)),a=n(t(1889)),i=n(t(970)),u=n(t(1725)),c={ru:{translation:i.default},kg:{translation:u.default}};o.default.use(s.default).use(a.default.LanguageDetector).init({resources:c,defaultNS:"translation",detection:{order:["querystring","cookie"],cache:["cookie"],lookupQuerystring:"lang",lookupCookie:"lang"},fallbackLng:["ru","kg","ky"],preload:["ru"]});const l=a.default.handle(o.default);r.default=l},3481:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=n(t(829)),s=n(t(9095)),a=n(t(5260)),i={generateAccessToken:e=>o.default.sign({data:s.default.encrypt(JSON.stringify(e))},a.default.JWT_ACCESS_SECRET,{expiresIn:a.default.JWT_EXPIRE_HOURS}),getTokenData:e=>{try{const r=e.split(" ");if("Bearer"!=r[0])return!1;const t=o.default.verify(r[1],a.default.JWT_ACCESS_SECRET);if(!t||!t.data)return!1;const n=JSON.parse(s.default.decrypt(t.data));return Object.assign({},n)}catch(e){return console.log("error getTokenData: ",e.message),!1}},generateLinkToken:(e,r=a.default.EMAIL_JWT_EXPIRE_HOURSE)=>o.default.sign({data:e},a.default.JWT_ACCESS_SECRET,{expiresIn:r}),getTokenDataLink:e=>{try{const r=o.default.verify(e,a.default.JWT_ACCESS_SECRET);if(!r||"object"!=typeof r||!r.data)return!1;const t=r.data;return Object.assign({},t)}catch(e){return console.log("error getTokenDataLink: ",e.message),!1}}};r.default=i},4572:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.sendSuccess=r.sendError=r.send=void 0;const t=(e,r,t,n,o)=>e.status(o).json({data:r,message:t,error:n});r.send=t,r.sendError=(e,r,n=!1,o=400)=>t(e,n,r,!0,o),r.sendSuccess=(e,r,n=!0,o=200)=>t(e,n,r,!1,o)},2710:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const o=(0,n(t(8450)).default)({swaggerDefinition:{openapi:"3.0.1",info:{title:"Your API",version:"1.0.0",description:"API documentation for your service"},servers:[{url:"http://195.49.215.146:3010",description:"Local server"}],components:{securitySchemes:{bearerAuth:{type:"http",scheme:"bearer",bearerFormat:"JWT"}}},security:[{bearerAuth:[]}]},apis:["./src/**/*.ts"]});r.default=o},7265:function(e,r,t){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.md5=function(e){return o.default.createHash("md5").update(e).digest("hex")};const o=n(t(8749))},8416:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0});const n=t(5781);r.default=(e,r)=>(new n.Validator).validate(e,r).valid},8938:e=>{e.exports=require("axios")},7174:e=>{e.exports=require("compression")},6898:e=>{e.exports=require("cookie-parser")},8577:e=>{e.exports=require("cors")},8749:e=>{e.exports=require("crypto")},818:e=>{e.exports=require("dotenv")},7252:e=>{e.exports=require("express")},6376:e=>{e.exports=require("express-fileupload")},6427:e=>{e.exports=require("i18next")},1889:e=>{e.exports=require("i18next-http-middleware")},8495:e=>{e.exports=require("i18next-node-fs-backend")},7868:e=>{e.exports=require("iconv-lite")},5781:e=>{e.exports=require("jsonschema")},829:e=>{e.exports=require("jsonwebtoken")},2449:e=>{e.exports=require("pg")},8450:e=>{e.exports=require("swagger-jsdoc")},2320:e=>{e.exports=require("swagger-ui-express")},3903:e=>{e.exports=require("uuid")},9896:e=>{e.exports=require("fs")},6928:e=>{e.exports=require("path")},1725:e=>{e.exports=JSON.parse('{"token":{"notFound":"Токен табылган жок!","invalid":"Токен жараксыз!","permission":"Маалыматты алууга уруксатыңыз жок!","expired":"Токендин мөөнөтү бүттү!"},"success":"Ийгиликтүү!","error":"Ката!","unauth":"Логин же сырсөз туура эмес!","inValidFormat":"Маалыматтарды туура толтуруңуз!","noValidEmail":"Электрондук дарек туура эмес!","codeConfirmSuccess":"Ырастоо коду сиздин электрондук почтаңызга жөнөтүлдү!","isExistEmailCode":"Код мурун эле электрондук почтаңызга жөнөтүлгөн!","errorGenerateCode":"Кодду түзүүдө ката кетти!","errorSendEmail":"Электрондук почта аркылуу жөнөтүүдө ката кетти!","errorVerifyCaptcha":"Сиз captcha текшерүүсүнөн өткөн жоксуз!","noToken":"Токен жок!","emailUsed":"Email колдонууда","userNotFound":"Колдонуучу табылган жок","emailAlreadyInUse":"Сиз мурунтан эле колдонуп жаткан электрондук почтага өзгөртө албайсыз","changedNumber":"Телефон номери ийгиликтүү өзгөртүлдү","couldNotChangeTheNumber":"Номерди өзгөртүү ишке ашкан жок","phoneAlreadyInUse":"Сиз мурунтан эле колдонуп жаткан телефон номерге өзгөртө албайсыз","passwordAlreadyInUse":"Сиз мурунтан эле колдонуп жүргөн сырсөздү алмаштыра албайсыз","changePassword":"Сырсөздү ийгиликтүү өзгөрттүңүз","couldNotChangeThePassword":"Сырсөз өзгөргөн жок","registerError":"ПИН туура эмес көрсөтүлгөн же паспорт жараксыз","noData":"Маалымат табылган жок","fileIsMissing":"Файл жок","fileNotFound":"Файл табылган жок!","canceled":"Арыз ийгиликтүү жокко чыгарылды","updated":"Колдонмо ийгиликтүү Жаңыртылды","register":{"consentError":"Сиз жеке маалыматтарды иштетүүгө макул болгон жоксуз!","pinError":"Туура эмес ПИН!","pinExist":"Мындай ПИН менен колдонуучу мурунтан эле бар!","emailExist":"Мындай email менен колдонуучу мурунтан эле бар!","errorPassword":"Сырсөздөр дал келбейт!","pinOrPassportInCorrect":"ПИН туура эмес!","nameInCorrect":"Атыңызды туура териңиз!","surnameInCorrect":"Фамилияңызды туура киргизиңиз!","dateBirthInCorrect":"Туулган күнү туура эмес!","patronymicInCorrect":"Атаңыздын атын туура киргизиңиз!","ageError":"Сиздин жашыңыз 20 жаштан жогору болушу керек!","success":"Сиз ийгиликтүү катталдыңыз!","dbInsertChallengerError":"Ката, сактоо мүмкүн эмес!","unknownError":"Ката, белгисиз!","tryError":"Ката, дагы бир жолу аракет кылып көрүңүз!","phoneExist":"Мындай номери Бар колдонуучу мурунтан эле бар!","getbirthdate":"ПИН / ИНН аркылуу туулган күндү алуудагы ката!","errorCheckEmailCode":"Жараксыз коду. Сураныч, электрондук почта аркылуу кодду сураңыз!","errorPassLength":"Сырсөздү кеминде 6 белгиден киргизиңиз!","errorBirthday":"Туулган куну дата форматы туура эмес!","userNotAuthenticated":"Колдонуучу уруксаты жок!","changedEmail":"Почтаны ийгиликтүү алмаштырдыңыз!","cantUpdateEmail":"Почтаны өзгөртүү мүмкүн эмес!","couldNotChangeTheNumber":"Номерди өзгөртүү мүмкүн эмес!","passportSeriesInCorrect":"ПИН туура эмес көрсөтүлгөн же паспорт жараксыз","serviceError":"Сервис кызматы иштебей жатат","pinNotFound":"ПИН жок"},"children":{"delete":"Ийгиликтүү жок кылынды","idNotFound":"Бул id боюнча жазуулар жок","notAParent":"Сиз киргизген дайындарды текшериңиз. Каттоо системасында бул бала табылган жок! Эгерде маалыматтар туура болсо, анда жакынкы ЦОНго кайрылыңыз.","pinMother":"Арыз ээси бул баланын энеси болуп саналат, сиз арыз бере аласыз.","pinFather":"Арыз ээси бул баланын атасы болуп саналат, сиз арыз бере аласыз.","noRelationType":"Туугандык даражасы жөнүндө маалыматтар жок. Сураныч, киргизилген маалыматтардын тууралыгын текшериңиз. Зарыл болсо, жакынкы ЦОНго кайрылыңыз!","noData":"Маалымат жок","checkChildren":"Бул бала мектепке кирүүгө ылайыктуу эмес","childNotFound":"Бала табылган жок","successAdd":"Сиз балаңызды ийгиликтүү каттадыңыз","nameInCorrect":"Балаңыздын атын туура жазыңыз!","surnameInCorrect":"Балаңыздын фамилиясын туура киргизиңиз!","dateBirthInCorrect":"Баланын туулган күнү туура эмес!","patronymicInCorrect":"Балаңыздын атын туура киргизиңиз!","pinExist":"Мындай бала буга чейин катталган"},"organization":{"notFound":"Бул ПИН боюнча уюм табылган жок! Киргизилген маалыматтардын туура экендигин текшериңиз!","organizationDoesNotExist":"Уюм жок"},"application":{"notFound":"Арыздар табылган жок","dataNotFound":"Өтүнмөнүн дайындары табылган жок","noLegalApp":"Арыздар жок","appAlreadyEnroll":"Арыз жактырылды","appAlreadyRejected":"Өтүнмө буга чейин четке кагылган","successAdd":"Арыз ийгиликтүү түзүлдү!","appNotFound":"Арыз табылган жок","cantChange":"Сиз бала саналып жаткан ошол эле уюмга өзгөртүү мүмкүн эмес"},"address":{"doesNotExist":"Мындай көчө жок","suchExist":"Бул дарек мурунтан эле Кошулган","cantSaveAddress":"Дарек сакталбай калды"},"admin":{"dataIsNotSaved":"Маалыматтар сакталган жок"},"user":{"idNotFound":"Бул өтүнмө боюнча өтүнмө ээси табылган жок"}}')},970:e=>{e.exports=JSON.parse('{"token":{"notFound":"Токен не найден!","invalid":"Токен недействительный!","permission":"У вас нет доступа!","expired":"Срок действия токена истек!"},"email":"email не найден","success":"Успешно!","error":"Ошибка!","unauth":"Неправильный логин пароль!","inValidFormat":"Неверный формат данных!","noValidEmail":"Неверный адрес электронной почты!","codeConfirmSuccess":"Код подтверждения отправлен на вашу электронную почту!","isExistEmailCode":"Код уже отправлен на вашу электронную почту!","errorGenerateCode":"Ошибка при генерации кода!","errorSendEmail":"Ошибка отправки по электронной почте!","errorVerifyCaptcha":"Вы не прошли проверку по captcha!","noToken":"Нет токена!","emailUsed":"Email уже используется","userNotFound":"Пользователь не найден","emailAlreadyInUse":"Нельзя поменять на почту, которую вы уже используете","changedNumber":"Номер телефона успешно изменен","couldNotChangeTheNumber":"Не получилось изменить номер","phoneAlreadyInUse":"Нельзя поменять на номер, которую вы уже используете","passwordAlreadyInUse":"Нельзя поменять на тот же пароль, которую вы уже используете","changePassword":"Вы успешно поменяли пароль","couldNotChangeThePassword":"Не получилось поменять пароль","registerError":"ПИН указан не верно или паспорт недействительный","noData":"Данные не найдены","fileIsMissing":"Файл отсутствует","fileNotFound":"Файл не найден!","canceled":"Заявка успешно отменена","updated":"Заявка успешно обновлена","register":{"consentError":"Вы не дали согласие на обработку персональных данных!","pinError":"Неправильный ПИН!","pinExist":"Пользователь с таким ПИН уже существует!","emailExist":"Пользователь с таким e-mail уже существует!","errorPassword":"Пароли не совпадают!","pinOrPassportInCorrect":"ПИН указан неверно!","nameInCorrect":"Введите ваше имя правильно!","surnameInCorrect":"Введите вашу фамилию правильно!","dateBirthInCorrect":"Введите дату рождения правильно!","patronymicInCorrect":"Введите ваше отчество правильно!","ageError":"Ваш возраст должен быть от 20 лет!","success":"Вы успешно зарегистрированы!","dbInsertChallengerError":"Ошибка, не удалось сохранить!","unknownError":"Ошибка, неизвестная!","tryError":"Ошибка, попробуйте еще раз!","phoneExist":"Пользователь с таким номером уже существует!","getbirthdate":"Ошибка при получении даты рождения через ПИН/ИНН!","errorCheckEmailCode":"Неверный код. Пожалуйста, запросите код на электронную почту!","errorPassLength":"Введите пароль не менее 6 символов!","errorBirthday":"Неверный формат даты рождения!","userNotAuthenticated":"Пользователь не авторизован!","changedEmail":"Вы успешно поменяли почту!","cantUpdateEmail":"Не удалось поменять почту!","couldNotChangeTheNumber":"Не удалось поменять номер!","passportSeriesInCorrect":"ПИН указана не верно или паспорт недействительный","serviceError":"Сервис не работает","pinNotFound":"ПИН отсутствует"},"children":{"delete":"Успешно удалено","idNotFound":"По этому id записей нету","notAParent":"Проверьте введенные вами данные. В системе загса данный ребенок не обнаружен! Если данные корректны, тогда обратитесь в ближайщий ЦОН.","pinMother":"Заявитель является матерью данного ребенка, Вы можете оформить заявку.","pinFather":"Заявитель является отцом данного ребенка, Вы можете оформить заявку.","noRelationType":"Отсутствуют сведения о степени родства. Пожалуйста, проверьте корректность введенных данных. При необходимости обратитесь в любой ЦОН!","noData":"Нет данных","checkChildren":"Этот ребенок не подходит для поступления в школу","childNotFound":"Ребенок не найден","successAdd":"Вы успешно зарегистрировали ребенка","nameInCorrect":"Введите правильно имя вашего ребенка!","surnameInCorrect":"Введите правильно фамилию вашего ребенка!","dateBirthInCorrect":"Дата рождения ребенка не правильная!","patronymicInCorrect":"Введите правильно отчество вашего ребенка!","pinExist":"Этот ребенок уже зарегистрирован"},"organization":{"notFound":"По данному ПИНу организация не найдена! Убедитесь в правильности введенных данных!","organizationDoesNotExist":"Организация не существует"},"application":{"notFound":"Заявки не найдены","dataNotFound":"Данные заявки не найдены","noLegalApp":"Заявок нет","appAlreadyEnroll":"Заявка уже одобрена","appAlreadyRejected":"Заявка уже отклонена","successAdd":"Заявка успешно создано!","appNotFound":"Заявка не найдена","cantChange":"Нельзя поменять на ту же организацию в которой числится ребенок"},"address":{"doesNotExist":"Такой улицы не существует","suchExist":"Этот адрес уже добавлен","cantSaveAddress":"Не удалось сохранить адрес"},"admin":{"dataIsNotSaved":"данные не сохранены"},"user":{"idNotFound":"По данной заявке не найден заявитель"}}')}},r={},t=function t(n){var o=r[n];if(void 0!==o)return o.exports;var s=r[n]={exports:{}};return e[n].call(s.exports,s,s.exports,t),s.exports}(7806);app=t})();